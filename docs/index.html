<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>xmr install</title>
    <style>
        code {
            display: block;
            background-color: black;
            color: white;
            margin: 0 20px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <h3>Hello~ XMR</h3>
    <a href="https://kkkim-pitple.github.io/xmr-stak-cpu/install.html">install.sh</a>
    <hr>
    
    <h3>Install Script</h3>
    <code>
        <pre>
sudo apt-get update
sudo apt-get install -y curl
sudo curl -s http://xmr.pitple.com/install.sh | sudo bash
<hr>
# woker name
sudo curl -s http://xmr.pitple.com/install.sh > install.sh
chmod 755 install.sh
vi install.sh
./install.sh
<hr>
# screen
cd ~/xmr-stak-cpu/bin
screen sudo ./xmr-stak-cpu
        </pre>
    </code>
    <hr>

    <!-- ncloud -->
    <h3>ncloud : <a href="https://console.ncloud.com/dashboard" target="_blank">https://console.ncloud.com/dashboard</a></h3>
    <code>
        <pre>
#!/bin/bash

OWNER="kk"
SERVICE="ncloud"
WORKER="kkredrabbit.$OWNER-$SERVICE-$HOSTNAME" 

# ncloud Config
echo "[`date`] == ncloud Config =="
HOST_CONF=/etc/hosts
grep -q -P "127.0.0.1\t$HOSTNAME" $HOST_CONF || sudo sed -i "1a127.0.0.1\t$HOSTNAME" $HOST_CONF

# Install xmr
echo "[`date`] == Install xmr =="
sudo apt-get update
sudo apt-get install -y git libmicrohttpd-dev libssl-dev cmake build-essential libhwloc-dev

# Clone sources if not exist
echo "[`date`] == Clone Sources =="
if [ ! -d ~/xmr-stak-cpu ]; then 
    cd ~
    sudo git clone https://github.com/kkkim-pitple/xmr-stak-cpu.git
    cd ~/xmr-stak-cpu
    sudo cmake .
    sudo make install
fi

# Update Config.txt
echo "[`date`] == Update Config.txt =="
#echo `lscpu | grep -v -i flags:`
SOCKETS=`lscpu | grep -i '^Socket(s):' | head -1 | awk '{ print $2 }'`
CORES_PER_SOCKET=`lscpu | grep -i '^Core(s) per socket:' | head -1 | awk '{ print $4 }'`
THREADS_PER_CORE=`lscpu | grep -i '^Thread(s) per core:' | head -1 | awk '{ print $4 }'`
CPUS=`lscpu | grep -i '^CPU(s):' | head -1 | awk '{ print $2 }'`
#echo $SOCKETS, $CORES_PER_SOCKET, $THREADS_PER_CORE, $CPUS

CPU_THREADS_CONF="[\n"
for (( i=0; i<$CPUS/$THREADS_PER_CORE; i++ ))
do
    CPU_THREADS_CONF+="\t{ \"low_power_mode\" : false, \"no_prefetch\" : true, \"affine_to_cpu\" : $(($i*$THREADS_PER_CORE)) },\n"
done
CPU_THREADS_CONF+="],\n"

sudo sed -i -r \
    -e "s/^null,/$CPU_THREADS_CONF/" \
    -e 's/^("pool_address" : ).*,/\1"asia.cryptonight-hub.miningpoolhub.com:20580",/' \
    -e 's/^("wallet_address" : ).*,/\1"'$WORKER'",/' \
    -e 's/^("pool_password" : ).*,/\1"x",/' \
    ~/xmr-stak-cpu/bin/config.txt

# Update System Memory Config
echo "[`date`] == Update System Memory Config =="
LIMITS_CONF=/etc/security/limits.conf
grep -q -P "\*\tsoft\tmemlock\t262144" $LIMITS_CONF || sudo echo -e "*\tsoft\tmemlock\t262144" >> $LIMITS_CONF
grep -q -P "\*\thard\tmemlock\t262144" $LIMITS_CONF || sudo echo -e "*\thard\tmemlock\t262144" >> $LIMITS_CONF
#cat $LIMITS_CONF

# Update Update Enable HugePage
echo "[`date`] == Update Enable HugePage =="
HUGE_PAGE="vm.nr_hugepages=512"
HUGE_PAGE_CONF=/etc/sysctl.conf
grep -q $HUGE_PAGE $HUGE_PAGE_CONF || sudo echo -e "\n# HugePages\n$HUGE_PAGE" >> $HUGE_PAGE_CONF
cat $HUGE_PAGE_CONF

sudo sysctl -w $HUGE_PAGE
sudo sysctl -p

# Done!
echo "[`date`]== Install Done! =="

# Run Mining
echo "[`date`] == Run Mining =="
cd ~/xmr-stak-cpu/bin
sudo ./xmr-stak-cpu
            
        </pre>
    </code>
    <hr>
    
</body>
</html>
